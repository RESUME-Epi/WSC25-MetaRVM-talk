---
title: "Developing and deploying a use-inspired metapopulation framework for stratified health outcomes"
subtitle: "Winter Simulation Conference, 2025"
author: "Presenter: Arindam Fadikar"
affiliation: "Decision and Infrastructure Sciences"
institute: "Argonne National Laboratory"
date: "December 8, 2025"
date-format: long
conference: "Winter Simulation Conference 2025"
bibliography: refs.bib
title-slide-attributes:
  data-background-image: "figures/Chicago.jpg"
  data-background-size: cover # Optional: Adjust how the image fits
  data-background-opacity: "0.25" # Optional: Adjust image opacity
echo: true
format:
  revealjs:
    theme: simple
    slide-number: true
    incremental: false
    smaller: true
    toc: false
    code-fold: false
    code-overflow: scroll
    self-contained: true
    progress: true
    transition: fade
    navigation-mode: vertical
    highlight-style: github
    code-block-background: "#f7f9fc"
    code-block-border-left: "#1a6f8f"   # MetaRVM teal
execute:
  echo: false
  warning: false
  message: false
  cache: false
---

## People involved

::: columns
::: {#argonne .column}
![](figures/ANL_RGB-01.png){width="50%"}

![](figures/anl-heads.png){width="90%"}

<!-- -   Arindam Fadikar\
-   Abby Stevens
-   Sara Rimer
-   Ignacio Martinez-Moyano
-   Nicholson Colllier
-   Jonathan Ozik
-   Charles Macal -->
:::

::: {#cdph .column}
![](figures/CDPH-Logo.png){width="50%"}

-   Chol Mabil
-   Emile Jorgensen
-   Peter Ruestow
-   V. Eloesa McSorley
:::
:::

------------------------------------------------------------------------

## Roadmap
::: {.columns .two-wide-narrow-panel}
::: column
-   Context\
-   MetaRVM modeling framework
    -   Metapopulation structure\
    -   Disease progression model\
    -   Mixing matrices from a synthetic population\
-   Implementation as an **R package**
-   Case study: influenza in Chicago
:::

::: column
![](figures/qrcode.png){width="100%"}
<https://tinyurl.com/wsc-metarvm>
:::

:::
------------------------------------------------------------------------

## Motivation
<!-- AFcomment: JO to work on -->
-   Public health decision makers increasingly rely on **epidemiological models** to:
    -   Forecast likely futures
    -   Stress-test interventions
    -   Plan resource allocation (e.g., beds, staffing)
-   Our team at Argonne (led by Chick Macal and Jonathan Ozik) was one of the four modeling groups in the Illinois Governor’s COVID-19 Modeling Taskforce, providing critical insights to support decision making during the pandemic
    -   We produced scenario analyses (e.g., potential impacts of mitigation efforts) and projections (e.g., future hospital capacity issues).
    -   Meetings were held twice weekly and analyses provided to the IDPH, CDPH, and Governor's office weekly
    -   Primary concerns became: 
        1.   developing analyses that were of utility to stakeholders 
        2.   fast time-to-solution

------------------------------------------------------------------------

## Motivation

::: columns
::: {#ode-panel .column}
#### **Population-based ODE model**

-   Aggregate-level dynamics\
-   Homogeneous mixing assumptions
-   Computationally light and fast

![](figures/ode-model.png){width="60%"}
:::

::: {#abm-panel .column}
#### **Agent-based model**

-   Individual-level interactions\
-   Heterogeneous contact network
-   Expensive to run for large population

![](figures/abm-model.png){width="60%"}
:::
:::

------------------------------------------------------------------------

## Motivation {data-auto-animate="true"}

::: {.columns .three-panel}
::: {#ode-panel-dim .column}
#### Population-based ODE model

-   Aggregate-level dynamics\
-   Homogeneous mixing assumptions

![](figures/ode-model.png){width="60%"}
:::

::: {#metarvm-panel .column}
#### Meta-population hybrid model
<!-- JOcomment: Hybrid because of the use of the ABM/schedules for the synthetic contacts -->
#### **MetaRVM**

-   Stratified metapopulation structure\
-   Time-varying mixing between strata

![](figures/meta-model.png){width="120%"}
:::

::: {#abm-panel-dim .column}
#### Agent-based model

-   Individual-level interactions\
-   Heterogeneous contact network

![](figures/abm-model.png){width="60%"}
:::
:::

------------------------------------------------------------------------

## MetaRVM {.incremental}

::: {.columns .two-wide-narrow-panel}
::: { .column}
-   An open-source **R package** for modeling infectious disease spread across **stratified subpopulations**.
-   Subpopulations can be defined by:
    -   Geography (e.g., neighborhood, ZIP, zone)
    -   Demographics (e.g., age, race/ethnicity)
-   Features:
    -   Time varying mixing pattern (weekday vs weekend, day vs night)
    -   Extended SEIR-type disease progression
    -   Checkpointing/restart functionality
:::

::: {.column .callout}
![](figures/metarvm-screenshot.png){width="120%"}
:::
:::


<!--- Integration with Trajectory-Oriented Optimization workflows -->
<!-- JOcomment: This last point is different from the others. Are we emphasizing the modularity or the checkpointing or both? We need to make the point clearer. -->
<!-- JOcomment: make this a two column page, with left column with text (wider) and a screenshot of the MetaRVM package page on the right, emphasizing the open and available nature. -->
<!-- AFcomment: DONE -->

------------------------------------------------------------------------

## MetaRVM - Disease model

![](figures/model.png){width="100%"}
<!-- JOcomment: Did you want to use the newer/cleaner image? The one in the website. -->
<!-- AFcomment: DONE -->

------------------------------------------------------------------------

## MetaRVM - Population mixing

![](figures/metafig.png){width="100%"}

-   Allows for subpopulations based on demographic characteristics, e.g., based on age: children (green boxes), working-age adults (blue boxes), and seniors (orange boxes)
-   Allows for different mixing patterns for daytime and nighttime: obtained through social mixing studies or through synthetic population schedules
<!-- JOcomment: Added some details here -->

------------------------------------------------------------------------

## Mixing and force of infection

![](figures/metafig.png){width="100%"}

-   For each stratum, the **force of infection** depends on:
    -   Mixing rates between the stratum $i$ and $j$ $M = (m_{ij}), \quad, i, j \in \mathcal{J}$ (set of all strata)
    -   Prevalence of infectious individuals in $j$th stratum at time $t$, $I_t^{(j)}$, where $j \in \mathcal{J}$


------------------------------------------------------------------------

## Mixing and force of infection

- Effective interacting population (exclude **Hospitalized [H]**, **Dead [D]** from total **Population [P]**)

$$
\mathrm{MP}_t^{(j)} = P_t^{(j)} - H_t^{(j)} - D_t^{(j)}, \qquad j \in \mathcal{J}.
$$

- Mixing across demographic strata

$M$: mixing matrix 
$$
M = (m_{ij}), \qquad \sum_{j \in \mathcal{J}} m_{ij} = 1 \ \forall i,
$$

$$
\mathrm{MP}_{t,\text{eff}}^{(j)} = \sum_{i \in \mathcal{J}} m_{ij}\,\mathrm{MP}_t^{(i)}, \quad
S_{t,\text{eff}}^{(j)} = \sum_{i \in \mathcal{J}} m_{ij}\,S_t^{(i)}, \quad
I_{t,\text{eff}}^{(j)} = \sum_{i \in \mathcal{J}} m_{ij}\,I_t^{(i)}.
$$

------------------------------------------------------------------------

## Mixing and force of infection

- **Force of infection (Susceptible [S] vs Vaccinated [V])**

$$
\lambda_{s,t}^{(j)} = \beta_s \frac{I_{t,\text{eff}}^{(j)}}{\mathrm{MP}_{t,\text{eff}}^{(j)}}, 
\qquad
\lambda_{v,t}^{(j)} = \beta_v \frac{I_{t,\text{eff}}^{(j)}}{\mathrm{MP}_{t,\text{eff}}^{(j)}}.
$$

- **Susceptible [S] → Exposed [E] transition in stratum (j)**

::: {.callout-important}
$$\text{probability of being infected:} \quad p_{\mathrm{SE}}^{(j)} = 1 - \exp\!\big(-\lambda_{s,t}^{(j)} \,\Delta t\big) \\
\text{New infections:} \quad \Delta E_t^{(j)} = p_{\mathrm{SE}}^{(j)}\,S_t^{(j)}$$
:::

------------------------------------------------------------------------

## Age-stratified model -- Illustration

#### Ingredients

::: {.columns .three-equal-panel}

::: {.column .fragment .zoom-step data-fragment-index="1" #col1}
**Population initialization**

- Age-groups: 0-17, 18-64, 65+
- Initial conditions 

![](figures/pop-init.png){width="70%"}
:::

::: {.column .fragment .zoom-step data-fragment-index="2" #col2}
**Vaccination**

- Daily vaccination counts

![](figures/daily_vax.png){width="100%"}
:::

::: {.column .fragment .zoom-step data-fragment-index="3" #col3}
**Mixing matrices**

- Time varying mixing 

![](figures/day_mixing.png){width="100%"}
![](figures/day_mixing.png){width="100%"}  <!-- or whatever your second figure is -->
:::

:::


<!-- JOcomment: Add ChiSIM reference at the bottom of page? -->

------------------------------------------------------------------------

## Age-stratified model -- Illustration

::: {.columns .two-wide-narrow-panel}

::: {.column}
#### Synthetic population

- Person demographics and household composition are derived from multiple
sources, including U.S. census data.

- Places include schools, workplaces, households, nursing homes and hospitals.

- Agent activity schedules are derived from the American Time Use Survey
and the Panel Study of Income dynamics.

<!-- -   Statistically representative ***synthetic population*** of Chicago
    (2.7M people, 1.4M places, 13K activity schedules)

-   ***Households*** from ACS + PUMS at the CBG level

-   ***Workplaces*** generated from County Business Patterns + LEHD OD data

-   ***Schools*** assigned to all school-aged children
    (some adults assigned schools as workplaces)

-   Additional ***mixing locations*** (restaurants, gyms, etc.) from SafeGraph -->
<!-- Do we need all these info? -->
:::

::: {.column}
#### ChiSIM
![](figures/ChiSIM_Synthpop.png){width="80%"}
![](figures/chisim-chicago.gif){width="60%"}
@macal2018chisim
:::

:::

------------------------------------------------------------------------

## Age-stratified model -- Illustration

::: {.columns .two-wide-narrow-panel}

::: {.column}
#### Mobility --\> Mixing
<!-- - **Agent mobility from real schedules**
  -  Adults: American Time Use Survey
  -  Children: Panel Study of Income Dynamics -->
<!-- -   Each agent draws 1 of 10 possible schedules daily (weekday/weekend) -->

- **Contact network** emerges from hour-by-hour co-location of agents

- **Aggregate**
  - Count the total number of contacts that occur at each location between and within subpopulations
  - Normalize the counts to arrive at per-capita value

:::

::: {.column}
#### ChiSIM
![](figures/chisim-mobility.gif){width="100%"}
@macal2018chisim
:::

:::
------------------------------------------------------------------------

## Daytime vs Nightime mixing

::: columns
::: {#daytime .column}
#### **Daytime**

-   Location based mixing

![](figures/day_contact.png){width="100%"}
:::

::: {#nighttime .column}
#### **Nighttime**

-   Household and community mixing

![](figures/night_contact.png){width="100%"}
:::
:::

------------------------------------------------------------------------

## MetaRVM in action

#### Prepare configuration 

```yml
run_id: age-stratified
population_data:
  mapping: demographic_mapping.csv
  initialization: population_init.csv
  vaccination: vaccination.csv
mixing_matrix:
  weekday_day: m_wd_d.csv
  weekday_night: m_wd_n.csv
  weekend_day: m_we_d.csv
  weekend_night: m_we_n.csv
disease_params:
  ts: 0.5
  tv: 0.3
  ve : 0.5
  dv: 158
  dp: 1
  de: 3
  da: 5
  ds: 6
  dh: 4
  dr: 187
  pea: 0.333
  psr: 0.95
  phr: 0.97
sub_disease_params:
    age:
      0-17:
        ts: 0.5
        tv: 0.1
        pea: 0.1
        psr: 0.99
      18-64:
        ts: 0.5
        tv: 4
        pea: 0.1
        psr: 0.99
      65+:
        ts: 0.5
        tv: 7
        pea: 0.3
        psr: 0.97
simulation_config:
  start_date: 8/01/2023 # m/d/Y
  length: 365
```

------------------------------------------------------------------------

## MetaRVM in action

#### Run simulation

```{r, echo = TRUE}
library(MetaRVM)
options(odin.verbose = FALSE)
out <- metaRVM("R/config.yaml")
print(out)
```
------------------------------------------------------------------------

## MetaRVM in action

#### Run simulation

```{r, echo = TRUE}
library(MetaRVM)
options(odin.verbose = FALSE)
out <- metaRVM("R/config.yaml")
print(out)
```

```{r, echo = TRUE}
out$results
```
------------------------------------------------------------------------

## MetaRVM in action

#### Visualize

```{r, echo = TRUE}
# extract new hospitalizations
out_H <- out$subset_data(disease_states = "n_IsympH")

library(ggplot2)
ggplot(out_H$results, aes(x = date, y = value, color = age)) + 
  geom_line() + 
  ylab("new hospitalizations") + theme_bw()
```
------------------------------------------------------------------------

## MetaRVM in action

#### Use of checkpoints

:::{.callout-tip}
```yaml
simulation_config:
  start_date: 8/01/2023 # m/d/Y
  length: 60
  checkpoint_dir: "path-to-the-checkpoint-directory"
  restore_from: "path-to-checkpoint-file"
```
:::

Run a simulation and checkpoint

```{r echo = FALSE}
config_file <- "R/config_checkpoint.yaml"
yml <- yaml::read_yaml(config_file)
yml_tmp <- data.table::copy(yml)

# Assign checkpoint directory
checkpoint_dir <- tempdir()
yml_tmp$simulation_config$checkpoint_dir <- checkpoint_dir

# Create a temporary config
temp_config <- tempfile(tmpdir = dirname(config_file), fileext = ".yaml")
yaml::write_yaml(yml_tmp, temp_config)
checkpoint_config <- normalizePath(temp_config)
```

```{r, echo = TRUE, eval = TRUE}
out <- metaRVM(checkpoint_config)
print(out)

# Check what checkpoint files were created
checkpoint_files <- list.files(checkpoint_dir, 
                               pattern = "^chk_.*\\.Rda$",
                               full.names = FALSE)
checkpoint_files
```

```{r, echo = FALSE}
unlink(temp_config)
```
------------------------------------------------------------------------

## MetaRVM in action

#### Use of checkpoints

:::{.callout-tip}
```yaml
simulation_config:
  start_date: 8/01/2023 # m/d/Y
  length: 60
  checkpoint_dir: "path-to-the-checkpoint-directory"
  restore_from: "path-to-checkpoint-file"
```
:::

Restore from a checkpoint

```{r echo = FALSE, eval = T}
# First run and checkpoint
config_file <- "R/config_checkpoint.yaml"
yml <- yaml::read_yaml(config_file)
yml_tmp <- data.table::copy(yml)

# Assign checkpoint directory
checkpoint_dir <- tempdir()
yml_tmp$simulation_config$checkpoint_dir <- checkpoint_dir

# Create a temporary config
temp_config <- tempfile(tmpdir = dirname(config_file), fileext = ".yaml")
yaml::write_yaml(yml_tmp, temp_config)
checkpoint_config <- normalizePath(temp_config)

out <- metaRVM(checkpoint_config)

checkpoint_files <- list.files(checkpoint_dir, 
                               pattern = "^chk_.*\\.Rda$",
                               full.names = TRUE)

# Restore and run
new_start_date <- "1/28/2024"
yml_tmp <- data.table::copy(yml)
yml_tmp$simulation_config$start_date <- new_start_date
yml_tmp$simulation_config$restore_from <- checkpoint_files[1]
yml_tmp$population_data$initialization <- NULL # ensure that we don't want to reinitialize the population from the initialization file

temp_config_resume <- tempfile(tmpdir = dirname(config_file),fileext = ".yaml")
yaml::write_yaml(yml_tmp, temp_config_resume)
config_resume <- normalizePath(temp_config_resume)
  
```

```{r, echo = TRUE, eval = T}
out <- metaRVM(config_resume)
print(out)
```

```{r, echo = FALSE, eval = T}
unlink(temp_config)
unlink(temp_config_resume)
```
------------------------------------------------------------------------

## MetaRVM in action

#### Use of checkpoints

```{r, echo = F}
# First run and checkpoint
config_file <- "R/config_checkpoint.yaml"
yml <- yaml::read_yaml(config_file)
yml_tmp <- data.table::copy(yml)

# Assign checkpoint directory
checkpoint_dir <- tempdir()
yml_tmp$simulation_config$checkpoint_dir <- checkpoint_dir

# Create a temporary config
temp_config <- tempfile(tmpdir = dirname(config_file), fileext = ".yaml")
yaml::write_yaml(yml_tmp, temp_config)
checkpoint_config <- normalizePath(temp_config)

out <- metaRVM(checkpoint_config)

out_H <- out$subset_data(disease_states = "n_IsympH")

library(ggplot2)
ggplot(out_H$results, aes(x = date, y = value, color = age)) + 
  geom_line() + 
  geom_vline(xintercept = as.Date("2024-01-27"), linetype = "dashed", linewidth = 1.3) + 
  xlim(as.Date("2023-08-01"), as.Date("2024-07-25")) +
  ylim(0, 60) +
  ylab("new hospitalizations") + theme_bw()

```

```{r, echo = FALSE, eval = T}
unlink(temp_config)
```

------------------------------------------------------------------------

## MetaRVM in action

#### Use of checkpoints

```{r, echo = F}
# First run and checkpoint
config_file <- "R/config_checkpoint.yaml"
yml <- yaml::read_yaml(config_file)
yml_tmp <- data.table::copy(yml)

# Assign checkpoint directory
checkpoint_dir <- tempdir()
yml_tmp$simulation_config$checkpoint_dir <- checkpoint_dir

# Create a temporary config
temp_config <- tempfile(tmpdir = dirname(config_file), fileext = ".yaml")
yaml::write_yaml(yml_tmp, temp_config)
checkpoint_config <- normalizePath(temp_config)

out <- metaRVM(checkpoint_config)

checkpoint_files <- list.files(checkpoint_dir, 
                               pattern = "^chk_.*\\.Rda$",
                               full.names = TRUE)

# Restore and run
new_start_date <- "01/28/2024"
yml_tmp <- data.table::copy(yml)
yml_tmp$simulation_config$start_date <- new_start_date
yml_tmp$simulation_config$restore_from <- checkpoint_files[1]
yml_tmp$population_data$initialization <- NULL # ensure that we don't want to reinitialize the population from the initialization file

temp_config_resume <- tempfile(tmpdir = dirname(config_file),fileext = ".yaml")
yaml::write_yaml(yml_tmp, temp_config_resume)
config_resume <- normalizePath(temp_config_resume)

out_resume <- metaRVM(config_resume)

out_H <- out$subset_data(disease_states = "n_IsympH")
out_resume_H <- out_resume$subset_data(disease_states = "n_IsympH")
out_H_all <- rbind(out_H$results, out_resume_H$results)

library(ggplot2)
ggplot(out_H_all, aes(x = date, y = value, color = age)) + 
  geom_line() + 
  geom_vline(xintercept = as.Date("2024-01-27"), linetype = "dashed", linewidth = 1.3) + 
  ylim(0, 60) +
  ylab("new hospitalizations") + theme_bw()

```

```{r, echo = FALSE, eval = T}
unlink(temp_config)
unlink(temp_config_resume)
```

------------------------------------------------------------------------

## Tracking age-stratified influenza hospitalizations in Chicago

- **Goal**:
  - Calibrate MetaRVM to weekly hospitalizations
  - Parameters to estimate: 
      - $ts$: transmissibility for susceptible population 
      - $tv$: transmissibility for vaccinated population 
      - $pea$: proportion of asymptomatic cases
      - $psh$: proportion of hospitalized among symptomatic cases
    
------------------------------------------------------------------------

## Tracking age-stratified influenza hospitalizations in Chicago

- **Approach**:
  - Apply ***Bayesian Optimization*** to find relevant trajectories matching the observed data (@fadikar2023TOO)

:::{.callout}
<center>
![](figures/TOO_screenshot.png){width="60%"}
</center>
:::

------------------------------------------------------------------------

## Tracking age-stratified influenza hospitalizations

![](figures/chicago_fit_1-30_90p.png){width="100%"}

Figure shows age-stratified hospitalization trajectories for the 2023–24 season that align with observed hospitalization counts (in black dots). Blue bands show the model-generated trajectories, and vertical dashed lines indicate the calibration windows where checkpoints are induced.


------------------------------------------------------------------------

## Tracking age-stratified influenza hospitalizations

::: {.columns .three-equal-panel}

::: {.column}
<center>
Week 1 - 10
![](figures/chicago_beta_1-10.png){width="100%"}
</center>
:::
::: {.column}
<center>
Week 11 - 20
![](figures/chicago_beta_11-20.png){width="100%"}
</center>
:::
::: {.column}
<center>
Week 21 - 30
![](figures/chicago_beta_21-30.png){width="100%"}
</center>
:::

:::

Figure shows the time-varying estimates of the transmission parameters ($ts$) for each age group, and for each 10-week calibration period. Diagonal panels display marginal posterior distributions for each age group, and off-diagonal panels show joint posterior contours.

------------------------------------------------------------------------


## Closing thoughts

- Enables tracking stratified health outcomes.
- Flexible in defining strata, time-strata varying model parameters.
- Available as an ***R-package***.

::: {.columns .two-wide-narrow-panel}

::: {.column}
### Current and future work

-   Extend MetaRVM to other respiratory diseases of public health concern (COVID, RSV) and additional demographic characteristics (geographic, race/ethnicity)
-   Apply checkpoint-aware Bayesian optimization 
-   Utilize moving windows for improved trend detection
-   Expand nowcasting capabilities to forecasting and scenario analyses
:::

:::{.column}
![](figures/qrcode.png){width="100%"}
:::
:::
------------------------------------------------------------------------

## Funding acknowledgments

- Chicago Department of Public Health
- This material is based upon work supported by the U.S. Department of Energy, Office of Science, under contract DE-AC02-06CH11357.

### References

::: {#refs}
:::

